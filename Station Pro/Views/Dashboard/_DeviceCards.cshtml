@model IEnumerable<DeviceDto>
@using StationPro
@using StationPro.Domain.Entities
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<SharedResources> Localizer

@foreach (var device in Model)
{
    var deviceIconClass = (device.Type == DeviceType.PS5 || device.Type == DeviceType.PS4 || device.Type == DeviceType.PS3) ? "fab fa-playstation" :
                         device.Type == DeviceType.Xbox ? "fab fa-xbox" :
                         device.Type == DeviceType.PC ? "fas fa-desktop" :
                         device.Type == DeviceType.PingPong ? "fas fa-table-tennis" :
                         (device.Type == DeviceType.Pool || device.Type == DeviceType.Billiards) ? "fas fa-circle" : "fas fa-gamepad";

    var statusClass = device.IsAvailable ? "available" : "in-use";
    var statusFilter = device.IsAvailable ? "available" : "in-use";
    var iconBgClass = device.IsAvailable ? "bg-green-100" : "bg-red-100";
    var iconColorClass = device.IsAvailable ? "text-green-600" : "text-red-600";
    var statusBadgeClass = device.IsAvailable ? "status-available" : "status-in-use";
    var multiSessionFilter = device.SupportsMultiSession ? "multi-session" : "";

    // Determine if current session is multi-session
    var isActiveMultiSession = device.CurrentSession?.SessionType == "multi";
    var sessionTypeText = isActiveMultiSession ? Localizer["Multi"] : Localizer["Single"];
    var sessionTypeIcon = isActiveMultiSession ? "fas fa-users" : "fas fa-user";
    var sessionTypeBgClass = isActiveMultiSession ? "bg-purple-50 border-purple-200" : "bg-blue-50 border-blue-200";
    var sessionTypeTextClass = isActiveMultiSession ? "text-purple-600" : "text-blue-600";

    <div class="device-card @statusClass fade-in"
         data-device-name="@device.Name.ToLower()"
         data-device-status="@statusFilter"
         data-device-id="@device.Id"
         data-multi-session="@multiSessionFilter">

        <!-- Device Header -->
        <div class="flex justify-between items-start mb-4">
            <div class="flex items-center space-x-3">
                <div class="@iconBgClass p-3 rounded-xl">
                    <i class="@deviceIconClass @iconColorClass text-2xl"></i>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-gray-900">@device.Name</h3>
                    <p class="text-sm text-gray-500">@device.TypeName</p>
                </div>
            </div>

            <!-- Status Badge -->
            <span class="status-badge @statusBadgeClass">
                @(device.IsAvailable ? Localizer["Available"] : Localizer["InUse"])
            </span>
        </div>

        <!-- Device Details -->
        <div class="border-t border-gray-100 pt-4 mb-4 space-y-3">

            @if (device.IsAvailable)
            {
                <!-- Show both rates when available -->
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600 flex items-center">
                            <i class="fas fa-user text-blue-600 mr-2"></i>
                            @Localizer["Single"]
                        </span>
                        <span class="text-lg font-bold text-blue-600">@device.SingleSessionRate.ToString("C")</span>
                    </div>

                    @if (device.SupportsMultiSession && device.MultiSessionRate.HasValue)
                    {
                        <div class="flex justify-between items-center p-2 bg-purple-50 rounded-lg border border-purple-200">
                            <span class="text-sm text-gray-600 flex items-center">
                                <i class="fas fa-users text-purple-600 mr-2"></i>
                                @Localizer["Multi"]
                            </span>
                            <span class="text-lg font-bold text-purple-600">@device.MultiSessionRate.Value.ToString("C")</span>
                        </div>
                    }
                </div>
            }
            else if (device.CurrentSession != null)
            {
                <!-- Session Type Badge -->
                <div class="flex justify-between items-center p-3 @sessionTypeBgClass rounded-lg border">
                    <div class="flex items-center">
                        <i class="@sessionTypeIcon @sessionTypeTextClass mr-2"></i>
                        <span class="text-sm font-medium @sessionTypeTextClass">@Localizer[sessionTypeText]</span>
                    </div>
                    <span class="text-lg font-bold @sessionTypeTextClass">@device.CurrentSession.HourlyRate.ToString("C")/@Localizer["hr"]</span>
                </div>

                <!-- Active Session Info (No Timer) -->
                <div class="bg-red-50 p-3 rounded-lg border-l-4 border-red-500 space-y-2">
                    <!-- Status Header -->
                    <div class="flex items-center justify-between">
                        <p class="text-xs text-gray-600">@Localizer["ActiveSession"]</p>
                        <span class="text-xs font-semibold text-red-600 uppercase">@Localizer["InUse"]</span>
                    </div>

                    <!-- Customer Name -->
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <span class="customer-name-label block">@Localizer["Customer"]:</span>

                        </div>

                        <span class="customer-name-value">
                            @(string.IsNullOrEmpty(device.CurrentSession.CustomerName) ? Localizer["Guest"] : device.CurrentSession.CustomerName)
                        </span>
                    </div>

                    <!-- After -->
                    <span class="hidden"
                          id="device-timer-@device.CurrentSession.Id"
                          data-start-time="@device.CurrentSession.StartTime.ToString("o")"
                          data-hourly-rate="@device.CurrentSession.HourlyRate">
                    </span>
                </div>
            }
        </div>

        <!-- Actions - Fixed at Bottom -->
        <div class="flex space-x-2">
            @if (device.IsAvailable)
            {
                @if (device.SupportsMultiSession)
                {
                    <!-- Split button for single/multi session -->
                    <div class="flex-1 flex space-x-1">
                        <button hx-post="@Html.TenantUrl("Dashboard", "QuickStart")?deviceId=@device.Id&isMultiSession=false"
                                hx-target="#active-sessions-container"
                                class="btn btn-success flex-1"
                                title="@Localizer["StartSingleSession"]">
                            <i class="fas fa-user mr-1"></i>
                            <span class="hidden sm:inline">@Localizer["Single"]</span>
                        </button>
                        <button hx-post="@Html.TenantUrl("Dashboard", "QuickStart")?deviceId=@device.Id&isMultiSession=true"
                                hx-target="#active-sessions-container"
                                class="btn btn-success"
                                style="background: linear-gradient(135deg, #9333ea 0%, #7e22ce 100%);"
                                title="@Localizer["StartMultiSession"]">
                            <i class="fas fa-users"></i>
                        </button>
                    </div>
                }
                else
                {
                    <button hx-post="@Html.TenantUrl("Dashboard", "QuickStart")?deviceId=@device.Id&isMultiSession=false"
                            hx-target="#active-sessions-container"
                            class="btn btn-success flex-1">
                        <i class="fas fa-play mr-2"></i>
                        @Localizer["Start"]
                    </button>
                }
            }
            else
            {
                <button class="btn btn-secondary flex-1 opacity-50 cursor-not-allowed" disabled>
                    <i class="fas fa-spinner fa-pulse mr-2"></i>
                    @Localizer["InUse"]
                </button>
            }
        </div>
    </div>
}