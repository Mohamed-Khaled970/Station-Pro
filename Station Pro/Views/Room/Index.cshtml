@model IEnumerable<RoomDto>
@using Microsoft.Extensions.Localization
@using StationPro
@using StationPro.Application.DTOs

@inject IStringLocalizer<SharedResources> Localizer

@{
    ViewData["Title"] = Localizer["Rooms"];
}

@section Styles {
    <link rel="stylesheet" href="~/css/room.css">
}

<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

        <!-- Page Header -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8 fade-in">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">
                    <i class="fas fa-door-open text-blue-600 mr-2"></i>
                    @Localizer["RoomsManagement"]
                </h1>
                <p class="text-gray-600">@Localizer["ManageVIPRooms"]</p>
            </div>
            <button onclick="openModal('add-room-modal')" class="btn btn-primary mt-4 md:mt-0">
                <i class="fas fa-plus mr-2"></i>@Localizer["AddRoom"]
            </button>
        </div>

        <!-- Stats Row -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 fade-in">
            <div class="card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">@Localizer["TotalRooms"]</p>
                        <p class="text-2xl font-bold text-gray-900">@Model.Count()</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-door-open text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">@Localizer["Available"]</p>
                        <p class="text-2xl font-bold text-green-600">@Model.Count(r => r.Status == "Available")</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-check-circle text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">@Localizer["Occupied"]</p>
                        <p class="text-2xl font-bold text-red-600">@Model.Count(r => r.Status == "Occupied")</p>
                    </div>
                    <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-users text-red-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Reserved</p>
                        <p class="text-2xl font-bold text-yellow-600">@Model.Count(r => r.Status == "Reserved")</p>
                    </div>
                    <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-calendar-check text-yellow-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters & Search -->
        <div class="card p-6 mb-8 fade-in">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                <div class="flex-1 max-w-md">
                    <div class="relative">
                        <input type="text" id="search-input"
                               placeholder="@Localizer["SearchRooms"]"
                               class="form-input pl-10" onkeyup="filterRooms()">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
                <div class="flex items-center space-x-2 flex-wrap gap-y-2">
                    <button onclick="filterByStatus('all')" class="filter-btn active" data-filter="all">All</button>
                    <button onclick="filterByStatus('available')" class="filter-btn" data-filter="available">@Localizer["Available"]</button>
                    <button onclick="filterByStatus('occupied')" class="filter-btn" data-filter="occupied">@Localizer["Occupied"]</button>
                    <button onclick="filterByStatus('reserved')" class="filter-btn" data-filter="reserved">Reserved</button>
                </div>
            </div>
        </div>

        <!-- Rooms Grid -->
        <div id="rooms-grid">
            @foreach (var room in Model)
            {
                <partial name="_RoomCard" model="room" />
            }
        </div>

        @if (!Model.Any())
        {
            <div class="card p-12 text-center">
                <i class="fas fa-door-open text-gray-300 text-6xl mb-4"></i>
                <h3 class="text-xl font-bold text-gray-900 mb-2">@Localizer["NoRoomsYet"]</h3>
                <p class="text-gray-600 mb-6">@Localizer["AddFirstRoom"]</p>
                <button onclick="openModal('add-room-modal')" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i>@Localizer["AddFirstRoomButton"]
                </button>
            </div>
        }
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════════
     QUICK BOOK MODAL  (Single OR Multi — type already chosen from card button)
════════════════════════════════════════════════════════════════════════════ -->
<div id="quick-book-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <div class="flex items-center space-x-3">
                <!-- Icon colour swapped dynamically by JS -->
                <div id="qb-icon-wrap" class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-user text-green-600 text-lg"></i>
                </div>
                <div>
                    <h3 id="qb-type-label" class="text-xl font-bold text-gray-900">Single Session</h3>
                    <p id="qb-room-label" class="text-sm text-gray-500">—</p>
                </div>
            </div>
        </div>
        <form id="quick-book-form">
            <!-- Hidden fields carrying context -->
            <input type="hidden" id="qb-room-id">
            <input type="hidden" id="qb-session-type">
            <input type="hidden" id="qb-hourly-rate">
            <input type="hidden" id="qb-max-guests">

            <div class="modal-body space-y-4">
                <div>
                    <label class="form-label"><i class="fas fa-user text-blue-600 mr-2"></i>Client Name</label>
                    <input type="text" id="qb-client-name" class="form-input" placeholder="Enter client name" required>
                </div>
                <div>
                    <label class="form-label"><i class="fas fa-users text-blue-600 mr-2"></i>Number of Guests</label>
                    <input type="number" id="qb-guest-count" class="form-input" min="1" value="1" required>
                    <p class="text-xs text-gray-400 mt-1" id="qb-guest-max">Max 2 persons</p>
                </div>

                <!-- Rate preview box — colours swapped by JS -->
                <div id="qb-rate-box" class="rounded-xl p-4 border bg-blue-50 border-blue-200 transition-colors duration-200">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Hourly Rate</span>
                        <span id="qb-rate-preview" class="font-bold text-lg text-blue-700">—</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Timer starts immediately upon booking.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeModal('quick-book-modal')" class="btn btn-secondary">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
                <button type="submit" id="qb-submit-btn" class="btn btn-success">
                    <i class="fas fa-play mr-2"></i>Start Single Session
                </button>
            </div>
        </form>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════════
     ADD ROOM MODAL
════════════════════════════════════════════════════════════════════════════ -->
<div id="add-room-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="text-xl font-bold text-gray-900">@Localizer["AddNewRoom"]</h3>
        </div>
        <form id="add-room-form" hx-post="/Room/Create"
              hx-target="#rooms-grid" hx-swap="afterbegin"
              hx-on::after-request="handleRoomAdded()">
            <div class="modal-body space-y-4">
                <div>
                    <label class="form-label"><i class="fas fa-tag text-blue-600 mr-2"></i>@Localizer["RoomName"]</label>
                    <input type="text" name="Name" class="form-input" placeholder="@Localizer["RoomNamePlaceholder"]" required>
                </div>

                <!-- Dual Rate Fields -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">
                            <i class="fas fa-user text-blue-500 mr-1"></i>
                            Single Rate (EGP)
                            <span class="text-xs text-gray-400 font-normal ml-1">≤ 2 persons</span>
                        </label>
                        <input type="number" name="SingleHourlyRate" class="form-input" placeholder="100" step="0.01" min="0" required>
                    </div>
                    <div>
                        <label class="form-label">
                            <i class="fas fa-users text-purple-500 mr-1"></i>
                            Multi Rate (EGP)
                            <span class="text-xs text-gray-400 font-normal ml-1">≤ 4 persons</span>
                        </label>
                        <input type="number" name="MultiHourlyRate" class="form-input" placeholder="160" step="0.01" min="0" required>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="form-label"><i class="fas fa-users text-blue-600 mr-2"></i>@Localizer["Capacity"]</label>
                        <input type="number" name="Capacity" class="form-input" placeholder="@Localizer["CapacityPlaceholder"]" min="1" required>
                    </div>
                    <div>
                        <label class="form-label"><i class="fas fa-gamepad text-blue-600 mr-2"></i>@Localizer["NumberOfDevices"]</label>
                        <input type="number" name="DeviceCount" class="form-input" placeholder="@Localizer["DeviceCountPlaceholder"]" min="0" value="0">
                    </div>
                </div>

                <div>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" name="HasAC" class="w-5 h-5 text-blue-600 border-gray-300 rounded">
                        <span class="text-sm font-medium text-gray-700">
                            <i class="fas fa-wind text-blue-600 mr-1"></i>@Localizer["RoomHasAC"]
                        </span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeModal('add-room-modal')" class="btn btn-secondary">
                    <i class="fas fa-times mr-2"></i>@Localizer["Cancel"]
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i>@Localizer["AddRoomButton"]
                </button>
            </div>
        </form>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════════
     EDIT ROOM MODAL
════════════════════════════════════════════════════════════════════════════ -->
<div id="edit-room-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="text-xl font-bold text-gray-900">@Localizer["EditRoom"]</h3>
        </div>
        <form id="edit-room-form">
            <input type="hidden" id="edit-room-id" name="Id">
            <div class="modal-body space-y-4">
                <div>
                    <label class="form-label">@Localizer["RoomName"]</label>
                    <input type="text" id="edit-room-name" name="Name" class="form-input" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">
                            <i class="fas fa-user text-blue-500 mr-1"></i>
                            Single Rate (EGP)
                            <span class="text-xs text-gray-400 font-normal ml-1">≤ 2 persons</span>
                        </label>
                        <input type="number" id="edit-room-single-rate" name="SingleHourlyRate" class="form-input" step="0.01" min="0" required>
                    </div>
                    <div>
                        <label class="form-label">
                            <i class="fas fa-users text-purple-500 mr-1"></i>
                            Multi Rate (EGP)
                            <span class="text-xs text-gray-400 font-normal ml-1">≤ 4 persons</span>
                        </label>
                        <input type="number" id="edit-room-multi-rate" name="MultiHourlyRate" class="form-input" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">@Localizer["Capacity"]</label>
                        <input type="number" id="edit-room-capacity" name="Capacity" class="form-input" min="1" required>
                    </div>
                    <div>
                        <label class="form-label"><i class="fas fa-gamepad text-blue-600 mr-2"></i>@Localizer["NumberOfDevices"]</label>
                        <input type="number" id="edit-room-devices" name="DeviceCount" class="form-input" min="0">
                    </div>
                </div>
                <div class="flex gap-4">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="edit-room-ac" name="HasAC" class="w-5 h-5 text-blue-600 border-gray-300 rounded">
                        <span class="text-sm font-medium text-gray-700">@Localizer["RoomHasAC"]</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="edit-room-active" name="IsActive" class="w-5 h-5 text-blue-600 border-gray-300 rounded">
                        <span class="text-sm font-medium text-gray-700">@Localizer["RoomIsActive"]</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeModal('edit-room-modal')" class="btn btn-secondary">@Localizer["Cancel"]</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save mr-2"></i>@Localizer["SaveChanges"]
                </button>
            </div>
        </form>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════════
     RESERVE ROOM MODAL
════════════════════════════════════════════════════════════════════════════ -->
<div id="reserve-room-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-yellow-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-calendar-plus text-yellow-600 text-lg"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-900">Reserve Room</h3>
                    <p class="text-sm text-gray-500" id="reserve-room-name-label">Hold this room for a future booking</p>
                </div>
            </div>
        </div>
        <form id="reserve-room-form">
            <input type="hidden" id="reserve-room-id">
            <div class="modal-body space-y-4">
                <div>
                    <label class="form-label"><i class="fas fa-user text-blue-600 mr-2"></i>Client Name</label>
                    <input type="text" id="reserve-client-name" class="form-input" placeholder="Enter client name" required>
                </div>
                <div>
                    <label class="form-label"><i class="fas fa-phone text-blue-600 mr-2"></i>Phone Number</label>
                    <input type="tel" id="reserve-phone" class="form-input" placeholder="01XXXXXXXXX">
                </div>
                <div>
                    <label class="form-label"><i class="fas fa-calendar text-blue-600 mr-2"></i>Reservation Date &amp; Time</label>
                    <input type="datetime-local" id="reserve-datetime" class="form-input" required>
                </div>
                <div>
                    <label class="form-label"><i class="fas fa-sticky-note text-blue-600 mr-2"></i>Notes</label>
                    <textarea id="reserve-notes" class="form-input" rows="2" placeholder="Any special requests..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeModal('reserve-room-modal')" class="btn btn-secondary">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
                <button type="submit" class="btn btn-warning">
                    <i class="fas fa-calendar-check mr-2"></i>Confirm Reservation
                </button>
            </div>
        </form>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════════
     END SESSION MODAL
════════════════════════════════════════════════════════════════════════════ -->
<div id="end-session-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-red-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-stop-circle text-red-600 text-lg"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-900">End Session</h3>
                    <p class="text-sm text-gray-500" id="end-session-room-label">—</p>
                </div>
            </div>
        </div>
        <div class="modal-body space-y-4">
            <input type="hidden" id="end-session-id">
            <input type="hidden" id="end-session-room-id">
            <div class="bg-red-50 rounded-xl p-4 border border-red-100 space-y-3">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600"><i class="fas fa-user mr-1 text-red-400"></i>Client</span>
                    <span class="font-bold text-gray-900" id="end-client-name">—</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600"><i class="fas fa-clock mr-1 text-red-400"></i>Duration</span>
                    <span class="font-mono font-bold text-red-700" id="end-session-duration">00:00:00</span>
                </div>
                <div class="flex justify-between text-sm border-t border-red-100 pt-2">
                    <span class="text-gray-700 font-semibold">Total Cost</span>
                    <span class="font-bold text-green-700 text-lg" id="end-session-cost">EGP 0.00</span>
                </div>
            </div>
            <p class="text-sm text-gray-500 text-center">
                The session will be ended and the room will become available.
            </p>
        </div>
        <div class="modal-footer">
            <button type="button" onclick="closeModal('end-session-modal')" class="btn btn-secondary">
                <i class="fas fa-times mr-2"></i>Cancel
            </button>
            <button onclick="confirmEndSession()" class="btn btn-danger">
                <i class="fas fa-stop-circle mr-2"></i>End Session
            </button>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════════
     RECEIPT MODAL
════════════════════════════════════════════════════════════════════════════ -->
<div id="receipt-modal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="w-full max-w-lg">
        <div id="receipt-content">
            <!-- Filled dynamically by room.js → showReceiptModal() after EndSession succeeds -->
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/session-timer.js"></script>
    <script src="~/js/room.js"></script>
}
