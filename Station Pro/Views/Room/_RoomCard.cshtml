@model RoomDto
@using Microsoft.Extensions.Localization
@using StationPro
@using StationPro.Application.DTOs

@inject IStringLocalizer<SharedResources> Localizer

@{
    var statusClass = Model.Status switch
    {
        "Available" => "available",
        "Occupied" => "occupied",
        "Reserved" => "reserved",
        _ => "maintenance"
    };
    var iconBgClass = Model.Status switch
    {
        "Available" => "bg-green-100",
        "Occupied" => "bg-red-100",
        "Reserved" => "bg-yellow-100",
        _ => "bg-gray-100"
    };
    var iconColorClass = Model.Status switch
    {
        "Available" => "text-green-600",
        "Occupied" => "text-red-600",
        "Reserved" => "text-yellow-600",
        _ => "text-gray-600"
    };
    var statusBadgeClass = Model.Status switch
    {
        "Available" => "status-available",
        "Occupied" => "status-occupied",
        "Reserved" => "status-reserved",
        _ => "status-maintenance"
    };

    var startTimeIso = Model.SessionStartTime.HasValue
        ? Model.SessionStartTime.Value.ToString("O")
        : string.Empty;

    var activeRate = Model.HourlyRate.ToString(System.Globalization.CultureInfo.InvariantCulture);
    var singleRateJs = Model.SingleHourlyRate.ToString(System.Globalization.CultureInfo.InvariantCulture);
    var multiRateJs = Model.MultiHourlyRate.ToString(System.Globalization.CultureInfo.InvariantCulture);

    var sessionTypeLabel = Model.SessionType ?? "Single";
    var sessionTypeBadgeCss = sessionTypeLabel == "Multi"
        ? "bg-purple-100 text-purple-700"
        : "bg-blue-100 text-blue-700";
    var sessionTypeIcon = sessionTypeLabel == "Multi" ? "fa-users" : "fa-user";

    // Localised session-type label for the badge
    var sessionTypeLabelLocalized = sessionTypeLabel == "Multi"
        ? Localizer["Multi"].Value
        : Localizer["Single"].Value;
}

<div class="room-card @statusClass fade-in"
     data-room-name="@Model.Name.ToLower()"
     data-room-status="@Model.Status.ToLower()"
     data-room-id="@Model.Id"
     id="room-card-@Model.Id">

    <!-- ── Header ──────────────────────────────────────────────────────────── -->
    <div class="flex justify-between items-start mb-4">
        <div class="flex items-center space-x-3">
            <div class="@iconBgClass p-3 rounded-xl">
                <i class="fas fa-door-open @iconColorClass text-2xl"></i>
            </div>
            <div>
                <h3 class="font-bold text-lg text-gray-900">@Model.Name</h3>
                <div class="flex items-center gap-2 mt-1">
                    @if (Model.HasAC)
                    {
                        <span class="text-xs text-blue-600 flex items-center">
                            <i class="fas fa-wind mr-1"></i>@Localizer["AC"]
                        </span>
                    }
                    <span class="text-xs text-gray-500">
                        <i class="fas fa-gamepad mr-1"></i>
                        @Model.DeviceCount @(Model.DeviceCount != 1 ? Localizer["DevicesPlural"] : Localizer["DevicesSingular"])
                    </span>
                </div>
            </div>
        </div>
        <span class="status-badge @statusBadgeClass">@Localizer[Model.Status]</span>
    </div>

    <!-- ── Rate & Capacity Details ─────────────────────────────────────────── -->
    <div class="card-details border-t border-gray-100 pt-4 mb-4 space-y-2">

        <!-- Single rate row -->
        <div class="flex justify-between items-center px-1">
            <span class="text-sm text-gray-500 flex items-center gap-1.5">
                <i class="fas fa-user text-blue-500 text-xs"></i> @Localizer["SingleRateLabel"]
            </span>
            <span class="text-sm font-bold text-blue-600">@Model.SingleHourlyRate.ToString("C")</span>
        </div>

        <!-- Multi rate row -->
        <div class="flex justify-between items-center px-1 rounded-lg @(Model.Status == "Available" ? "bg-purple-50 py-1" : "")">
            <span class="text-sm text-gray-500 flex items-center gap-1.5">
                <i class="fas fa-users text-purple-500 text-xs"></i> @Localizer["MultiRateLabel"]
            </span>
            <span class="text-sm font-bold text-purple-600">@Model.MultiHourlyRate.ToString("C")</span>
        </div>

        <!-- Capacity -->
        <div class="flex justify-between items-center px-1">
            <span class="text-sm text-gray-500">
                <i class="fas fa-users mr-1"></i>@Localizer["Capacity"]
            </span>
            <span class="text-sm font-bold text-gray-900">@Model.Capacity @Localizer["People"]</span>
        </div>

        <!-- ── Occupied: live timer block ──────────────────────────────────── -->
        @if (Model.Status == "Occupied" && Model.SessionStartTime.HasValue && Model.ActiveSessionId.HasValue)
        {
            <div class="bg-red-50 p-3 rounded-lg border-l-4 border-red-500 mt-1">

                <!-- Client + session-type pill -->
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-1.5 flex-wrap">
                        <span class="text-xs text-gray-600 font-medium">
                            <i class="fas fa-user mr-1 text-red-500"></i>@(Model.SessionClientName ?? Localizer["Guest"].Value)
                        </span>
                        <span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded-full text-xs font-bold @sessionTypeBadgeCss">
                            <i class="fas @sessionTypeIcon"></i> @sessionTypeLabelLocalized
                        </span>
                    </div>
                    <span class="text-xs font-bold text-red-600">
                        @Model.CurrentOccupancy / @Model.Capacity @Localizer["Guests"]
                    </span>
                </div>

                <!-- Active rate -->
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs text-gray-500"><i class="fas fa-tag mr-1"></i>@Localizer["RateLabel"]</span>
                    <span class="text-xs font-bold @(sessionTypeLabel == "Multi" ? "text-purple-700" : "text-blue-700")">
                        @Model.HourlyRate.ToString("C")/hr
                    </span>
                </div>

                <!-- Occupancy bar -->
                <div class="bg-gray-200 rounded-full h-1.5 mb-3">
                    <div class="bg-red-500 h-1.5 rounded-full"
                         style="width:@((Model.CurrentOccupancy * 100.0 / Model.Capacity).ToString("F0"))%"></div>
                </div>

                <!-- Live timer -->
                <div class="flex justify-between items-center">
                    <span class="text-xs text-gray-500"><i class="fas fa-clock mr-1"></i>@Localizer["DurationLabel"]</span>
                    <span class="font-mono font-bold text-red-700 text-sm timer-display-@Model.ActiveSessionId"
                          id="timer-@Model.ActiveSessionId"
                          data-start-time="@startTimeIso"
                          data-hourly-rate="@activeRate">
                        00:00:00
                    </span>
                </div>

                <!-- Running cost -->
                <div class="flex justify-between items-center mt-1">
                    <span class="text-xs text-gray-500"><i class="fas fa-coins mr-1"></i>@Localizer["RunningCost"]</span>
                    <span class="font-bold text-green-700 text-sm cost-display-@Model.ActiveSessionId"
                          id="cost-@Model.ActiveSessionId">
                        EGP 0.00
                    </span>
                </div>
            </div>
        }

        <!-- ── Reserved block ──────────────────────────────────────────────── -->
        @if (Model.Status == "Reserved")
        {
            <div class="bg-yellow-50 p-3 rounded-lg border-l-4 border-yellow-500">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-xs text-gray-600 font-medium">
                        <i class="fas fa-user mr-1 text-yellow-600"></i>@(Model.ReservationClientName ?? Localizer["Client"].Value)
                    </span>
                    <span class="text-xs font-bold text-yellow-700">@Localizer["ReservedBadge"]</span>
                </div>
                @if (Model.ReservationTime.HasValue)
                {
                    <div class="text-xs text-gray-500 mt-1">
                        <i class="fas fa-calendar-check mr-1"></i>
                        @Model.ReservationTime.Value.ToString("ddd, MMM d • h:mm tt")
                    </div>
                }
                @if (!string.IsNullOrEmpty(Model.ReservationNotes))
                {
                    <div class="text-xs text-gray-400 mt-1 italic truncate">@Model.ReservationNotes</div>
                }
            </div>
        }
    </div>

    <!-- ── Action Buttons ──────────────────────────────────────────────────── -->
    <div class="card-actions">
        @if (Model.Status == "Available")
        {
            <!-- Row 1: Single | Multi — equal halves -->
            <div class="btn-row">
                <button onclick="openQuickBookModal(@Model.Id, '@Html.Raw(Model.Name.Replace("'", "\\'"))', 'Single', '@singleRateJs', 2)"
                        class="btn btn-success btn-session">
                    <i class="fas fa-user"></i>
                    <span>@Localizer["SingleBtn"]</span>
                </button>
                <button onclick="openQuickBookModal(@Model.Id, '@Html.Raw(Model.Name.Replace("'", "\\'"))', 'Multi', '@multiRateJs', 4)"
                        class="btn btn-multi btn-session">
                    <i class="fas fa-users"></i>
                    <span>@Localizer["MultiBtn"]</span>
                </button>
            </div>
            <!-- Row 2: Reserve (stretches) + Edit + Delete -->
            <div class="btn-row">
                <button onclick="openReserveModal(@Model.Id, '@Html.Raw(Model.Name.Replace("'", "\\'"))')"
                        class="btn btn-warning btn-utility">
                    <i class="fas fa-calendar-plus"></i>
                    <span>@Localizer["Reserve"]</span>
                </button>
                <button onclick="editRoom(@Model.Id)" class="btn btn-outline btn-icon-only" title="@Localizer["EditBtn"]">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteRoom(@Model.Id, '@Html.Raw(Model.Name.Replace("'", "\\'"))')"
                        class="btn btn-danger btn-icon-only" title="@Localizer["DeleteBtn"]">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        }
        else if (Model.Status == "Occupied" && Model.ActiveSessionId.HasValue)
        {
            <div class="btn-row">
                <button onclick="openEndSessionModal(@Model.Id, @Model.ActiveSessionId.Value, '@Html.Raw(Model.Name.Replace("'", "\\'"))', '@Html.Raw((Model.SessionClientName ?? Localizer["Guest"].Value).Replace("'", "\\'"))')"
                        class="btn btn-danger btn-utility">
                    <i class="fas fa-stop-circle"></i>
                    <span>@Localizer["EndSessionBtn"]</span>
                </button>
                <button onclick="editRoom(@Model.Id)" class="btn btn-outline btn-icon-only" title="@Localizer["EditBtn"]">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteRoom(@Model.Id, '@Html.Raw(Model.Name.Replace("'", "\\'"))')"
                        class="btn btn-danger btn-icon-only" title="@Localizer["DeleteBtn"]">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        }
        else if (Model.Status == "Reserved")
        {
            <!-- Row 1: Check In | Cancel -->
            <div class="btn-row">
                <button onclick="activateReservation(@Model.Id, '@Html.Raw(Model.Name.Replace("'", "\\'"))')"
                        class="btn btn-success btn-session">
                    <i class="fas fa-check-circle"></i>
                    <span>@Localizer["CheckIn"]</span>
                </button>
                <button onclick="cancelReservation(@Model.Id, '@Html.Raw(Model.Name.Replace("'", "\\'"))')"
                        class="btn btn-secondary btn-session">
                    <i class="fas fa-calendar-times"></i>
                    <span>@Localizer["CancelReservation"]</span>
                </button>
            </div>
            <!-- Row 2: Edit (stretches) | Delete -->
            <div class="btn-row">
                <button onclick="editRoom(@Model.Id)" class="btn btn-outline btn-utility" title="@Localizer["EditBtn"]">
                    <i class="fas fa-edit"></i>
                    <span>@Localizer["EditBtn"]</span>
                </button>
                <button onclick="deleteRoom(@Model.Id, '@Html.Raw(Model.Name.Replace("'", "\\'"))')"
                        class="btn btn-danger btn-icon-only" title="@Localizer["DeleteBtn"]">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        }
        else
        {
            <div class="btn-row">
                <button class="btn btn-secondary btn-utility opacity-50 cursor-not-allowed" disabled>
                    <i class="fas fa-tools"></i>
                    <span>@Localizer["MaintenanceBtn"]</span>
                </button>
                <button onclick="editRoom(@Model.Id)" class="btn btn-outline btn-icon-only" title="@Localizer["EditBtn"]">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteRoom(@Model.Id, '@Html.Raw(Model.Name.Replace("'", "\\'"))')"
                        class="btn btn-danger btn-icon-only" title="@Localizer["DeleteBtn"]">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        }
    </div>
</div>
